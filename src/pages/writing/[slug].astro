---
import BaseLayout from '../../layouts/BaseLayout.astro';
import SEO from '../../components/SEO.astro';
import StructuredData from '../../components/StructuredData.astro';
import TableOfContents from '../../components/TableOfContents.astro';
import ScrollToTop from '../../components/ScrollToTop.astro';
import BackLink from '../../components/BackLink.astro';
import { getCollection, getEntry, render } from 'astro:content';
import { getReadingTime } from '../../utils/readingTime';

export async function getStaticPaths() {
	const articles = await getCollection('writing', ({ data }) => {
		return data.draft === false;
	});
	return articles.map((article) => ({
		params: { slug: article.id },
	}));
}

const { slug } = Astro.params;

/**
 * Retrieves the specific article entry by slug
 *
 * Redirects to 404 if the article is not found.
 */
const article = await getEntry('writing', slug!);

if (!article) {
	return Astro.redirect('/404');
}

/**
 * Renders the article content and extracts headings
 *
 * The Content component renders the MDX, and headings are used for
 * the table of contents generation.
 */
const { Content, headings } = await render(article);

const { title, description, publishDate, updatedDate, tags } = article.data;

/**
 * Calculates reading time from the article body
 *
 * Uses word count to estimate reading time in minutes.
 */
const readingTime = getReadingTime(article.body || '');

/**
 * Formats a date object for display
 *
 * Uses US English locale with full date format.
 * Example output: "January 15, 2024"
 *
 * @param date - The date to format
 * @returns Formatted date string
 */
function formatDate(date: Date): string {
	return new Intl.DateTimeFormat('en-US', {
		year: 'numeric',
		month: 'long',
		day: 'numeric',
	}).format(date);
}
---

<BaseLayout>
	<SEO
		slot="head"
		title={`${title} - Writing`}
		description={description}
		type="article"
		image={`/og/${slug}.png`}
		publishDate={publishDate}
		updatedDate={updatedDate}
	/>

	<StructuredData
		type="Article"
		data={{
			title,
			description,
			publishDate,
			updatedDate,
			tags,
			url: Astro.url.href,
		}}
	/>

	<main class="article">
		<!-- Article Header -->
		<header class="article-header">
			<h1>{title}</h1>
			<div class="article-meta">
				<time class="publish-date" datetime={publishDate.toISOString()}>
					{formatDate(publishDate)}
				</time>
				<span class="meta-separator">·</span>
				<span class="reading-time">{readingTime}</span>
				{
					updatedDate && (
						<>
							<span class="meta-separator">·</span>
							<time class="updated-date" datetime={updatedDate.toISOString()}>
								Updated {formatDate(updatedDate)}
							</time>
						</>
					)
				}
			</div>
			{
				tags && tags.length > 0 && (
					<div class="article-tags">
						{tags.map((tag) => (
							<span class="tag">{tag}</span>
						))}
					</div>
				)
			}
		</header>

		<!-- Table of Contents (conditionally rendered if 3+ sections) -->
		<TableOfContents headings={headings} />

		<!-- Article Content -->
		<article class="article-content">
			<Content />
		</article>

		<BackLink href="/writing" text="All articles" />
	</main>

	<ScrollToTop />

	<style>
		.article {
			max-width: 800px;
			margin: 0 auto;
			padding: 2rem 1.5rem;
		}

		.article-header {
			margin-bottom: 3rem;
			padding-bottom: 2rem;
			border-bottom: 1px solid var(--color-border);
		}

		.article-header h1 {
			font-size: 2.5rem;
			margin-bottom: 1rem;
			font-weight: 700;
			letter-spacing: -0.02em;
			line-height: 1.2;
		}

		.article-meta {
			display: flex;
			align-items: center;
			gap: 0.75rem;
			font-size: 0.9375rem;
			color: var(--color-text-secondary);
			margin-bottom: 1rem;
		}

		.meta-separator {
			opacity: 0.5;
		}

		.article-tags {
			display: flex;
			flex-wrap: wrap;
			gap: 0.5rem;
			margin-top: 1rem;
		}

		.tag {
			font-size: 0.8125rem;
			padding: 0.25rem 0.75rem;
			background: var(--color-bg-secondary);
			border: 1px solid var(--color-border);
			border-radius: 4px;
			color: var(--color-text-secondary);
		}

		.article-content {
			color: var(--color-text);
		}

		.article-content h1,
		h2,
		h3,
		h4,
		h5,
		h6 {
			max-width: 100%;
			white-space: pre-line;
		}

		.article-content :global(h2) {
			font-size: 1.75rem;
			margin-top: 1.5rem;
			margin-bottom: 1rem;
			font-weight: 700;
			letter-spacing: -0.01em;
			line-height: 1.3;
			color: var(--color-text);
		}

		.article-content :global(h3) {
			font-size: 1.25rem;
			margin-top: 2rem;
			margin-bottom: 0.75rem;
			font-weight: 600;
			letter-spacing: -0.01em;
			line-height: 1.4;
			color: var(--color-text);
		}

		.article-content :global(h4) {
			font-size: 1.125rem;
			margin-top: 1.5rem;
			margin-bottom: 0.5rem;
			font-weight: 600;
			line-height: 1.5;
			color: var(--color-text);
		}

		.article-content :global(p) {
			margin-bottom: 1.5rem;
			color: var(--color-text-secondary);
			font-size: var(--font-size-base);
		}

		.article-content :global(ul),
		.article-content :global(ol) {
			margin-bottom: 1.5rem;
			padding-left: 1.5rem;
			color: var(--color-text-secondary);
		}

		.article-content :global(li) {
			margin-bottom: 0.5rem;
			line-height: 1.7;
		}

		.article-content :global(blockquote) {
			margin: 2rem 0;
			padding: 1rem 1.5rem;
			border-left: 4px solid var(--color-accent);
			background: var(--color-bg-secondary);
			font-style: italic;
			color: var(--color-text-secondary);
		}

		.article-content :global(code) {
			font-family: var(--code-font-family), var(--alt-font-family), monospace;
			font-size: 0.85rem;
			background: var(--color-bg-secondary);
			padding: 0.2em 0.4em;
			border-radius: 3px;
		}

		.article-content :global(pre) {
			margin: 1rem 0;
			line-height: 1.4rem;
			background: var(--color-bg-secondary);
			border: 1px solid var(--color-border);
			border-radius: 8px;
			overflow-x: auto;

			&::-webkit-scrollbar {
				display: none;
			}
		}

		.article-content :global(pre code) {
			background: none;
			padding: 0;
		}

		.article-content :global(a) {
			color: var(--color-accent);
			text-decoration: underline;
			text-underline-offset: 4px;
		}

		.article-content :global(a:hover) {
			color: var(--color-accent-hover);
		}

		.article-content :global(img) {
			max-width: 100%;
			height: auto;
			border-radius: 8px;
			margin: 2rem 0;
		}

		.article-content :global(hr) {
			margin: 3rem 0;
			border: none;
			border-top: 1px solid var(--color-border);
		}

		.article-content :global(strong) {
			color: var(--color-text);
			font-weight: 600;
		}

		@media (max-width: 768px) {
			.article {
				padding: 1.5rem 1rem;
				width: 100%;
				overflow-x: auto;
				-webkit-overflow-scrolling: touch;
			}

			.article {
				padding: 1.5rem 1rem;
			}

			.article-header h1 {
				font-size: 2rem;
			}

			.article-content {
				font-size: 1rem;
			}

			.article-content :global(h2) {
				font-size: 1.5rem;
			}

			.article-content :global(h3) {
				font-size: 1.25rem;
			}

			.article-content :global(h4) {
				font-size: 1.0625rem;
			}

			.article-content :global(pre) {
				padding: 1rem;
			}
		}
	</style>
</BaseLayout>
